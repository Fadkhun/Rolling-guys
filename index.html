<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Ayang Face Swap â€” with Progress Bar</title>

  <!-- Load face-api.js -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <style>
    :root {
      --bg: #0f0f12;
      --card: #1c1c21;
      --text: #e0e0e0;
      --muted: #83838f;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --success: #10b981;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', Inter, system-ui, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Layout Utama */
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 16px;
      width: 100%;
      flex: 1;
      overflow-y: auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 12px;
    }

    h1 { margin: 0; font-size: 1.25rem; font-weight: 700; color: #fff; }
    .badge { 
      font-size: 0.75rem; 
      background: rgba(255,255,255,0.1); 
      padding: 4px 8px; 
      border-radius: 6px; 
      color: var(--muted);
    }
    .badge.ready { color: var(--success); background: rgba(16, 185, 129, 0.15); }

    /* Grid Input */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 600px) {
      .grid { grid-template-columns: 1fr; }
    }

    /* Card Style */
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.05);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card-title { font-size: 0.9rem; font-weight: 600; color: var(--muted); }

    /* Custom File Input */
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    .file-btn {
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px dashed rgba(255,255,255,0.2);
      color: var(--text);
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      font-size: 0.85rem;
      cursor: pointer;
      transition: 0.2s;
    }
    .file-btn:active { background: rgba(255,255,255,0.1); }
    input[type=file] {
      font-size: 100px;
      position: absolute;
      left: 0; top: 0; opacity: 0;
      width: 100%; height: 100%;
      cursor: pointer;
    }

    /* Preview Image */
    .preview-box {
      width: 100%;
      height: 200px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .preview-box img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .preview-placeholder { font-size: 0.8rem; color: var(--muted); }

    /* Action Area */
    .actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    
    button {
      flex: 1;
      padding: 14px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.1s;
    }
    button:active { transform: scale(0.98); }

    .btn-primary { background: var(--accent); color: white; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: var(--text); }
    .btn-primary:disabled { background: var(--muted); opacity: 0.5; cursor: not-allowed; }

    /* Result Canvas */
    .result-container {
      margin-top: 24px;
      text-align: center;
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.05);
      display: none; /* Hidden by default */
    }
    .result-container.show { display: block; }
    canvas {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    /* OVERLAY LOADING */
    #overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(5px);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      visibility: hidden; opacity: 0;
      transition: 0.3s;
    }
    #overlay.active { visibility: visible; opacity: 1; }

    .loader-content {
      background: #222;
      padding: 24px;
      border-radius: 16px;
      width: 280px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Progress Bar */
    .progress-track {
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      margin: 16px 0 8px 0;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s ease;
    }
    .loading-text { font-size: 0.9rem; margin-bottom: 4px; }
    .loading-percent { font-size: 1.5rem; font-weight: 700; color: var(--accent); }

  </style>
</head>
<body>

  <!-- Overlay Loading -->
  <div id="overlay" class="active">
    <div class="loader-content">
      <div class="loading-text" id="loadingStatus">Menyiapkan AI...</div>
      <div class="loading-percent" id="loadingPercent">0%</div>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div style="font-size:0.75rem; color:#666; margin-top:10px">
        Mohon tunggu, memuat model wajah...
      </div>
      <button id="retryBtn" class="btn-secondary" style="margin-top:15px; font-size:0.8rem; padding:8px; display:none;">Ulangi Load</button>
    </div>
  </div>

  <div class="container">
    <header>
      <h1>Ayang Face Swap</h1>
      <div id="statusBadge" class="badge">Initializing...</div>
    </header>

    <div class="grid">
      <!-- Target Image -->
      <div class="card">
        <div class="card-title">1. Target (Badan/Wajah Asli)</div>
        <div class="preview-box" id="previewContainer1">
          <span class="preview-placeholder">Pilih Foto</span>
        </div>
        <div class="file-input-wrapper">
          <div class="file-btn">Upload Foto Target</div>
          <input type="file" id="img1Input" accept="image/*">
        </div>
      </div>

      <!-- Donor Image -->
      <div class="card">
        <div class="card-title">2. Donor (Wajah Pengganti)</div>
        <div class="preview-box" id="previewContainer2">
          <span class="preview-placeholder">Pilih Foto</span>
        </div>
        <div class="file-input-wrapper">
          <div class="file-btn">Upload Foto Donor</div>
          <input type="file" id="img2Input" accept="image/*">
        </div>
      </div>
    </div>

    <div class="actions">
      <button id="swapBtn" class="btn-primary" disabled>Tukar Wajah</button>
      <button id="resetBtn" class="btn-secondary">Reset</button>
    </div>

    <div class="result-container" id="resultArea">
      <h3 style="margin-top:0; color:var(--muted)">Hasil Swap</h3>
      <canvas id="outputCanvas"></canvas>
      <div style="margin-top:12px">
        <a id="downloadLink" href="#" style="color:var(--accent); text-decoration:none; font-size:0.9rem;">Download Hasil</a>
      </div>
    </div>

    <div style="margin-top:30px; font-size:0.75rem; color:var(--muted); text-align:center; line-height:1.5;">
      Note: Aplikasi ini berjalan sepenuhnya di browser Anda (Client Side).<br>
      Foto tidak dikirim ke server manapun. Gunakan pencahayaan yang mirip untuk hasil terbaik.
    </div>
  </div>

<script>
  // --- KONFIGURASI & UI ---
  const UI = {
    overlay: document.getElementById('overlay'),
    loadingStatus: document.getElementById('loadingStatus'),
    loadingPercent: document.getElementById('loadingPercent'),
    progressFill: document.getElementById('progressFill'),
    retryBtn: document.getElementById('retryBtn'),
    statusBadge: document.getElementById('statusBadge'),
    swapBtn: document.getElementById('swapBtn'),
    resetBtn: document.getElementById('resetBtn'),
    resultArea: document.getElementById('resultArea'),
    canvas: document.getElementById('outputCanvas'),
    downloadLink: document.getElementById('downloadLink')
  };

  const INPUTS = {
    target: { input: document.getElementById('img1Input'), container: document.getElementById('previewContainer1'), img: null },
    donor: { input: document.getElementById('img2Input'), container: document.getElementById('previewContainer2'), img: null }
  };

  let modelsLoaded = false;

  // --- LOGIKA LOADING MODEL DENGAN PERSENTASE ---
  async function loadModels() {
    UI.retryBtn.style.display = 'none';
    const modelBase = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
    
    // Kita memuat 3 model utama. Kita akan hitung progress per model.
    // 1. TinyFaceDetector (deteksi wajah ringan)
    // 2. FaceLandmark68Net (titik koordinat wajah)
    // 3. FaceRecognitionNet (opsional, tapi bagus untuk alignment)
    
    const tasks = [
      { name: 'Detector', promise: faceapi.nets.tinyFaceDetector.loadFromUri(modelBase) },
      { name: 'Landmarks', promise: faceapi.nets.faceLandmark68Net.loadFromUri(modelBase) },
      { name: 'Recognition', promise: faceapi.nets.faceRecognitionNet.loadFromUri(modelBase) }
    ];

    let completed = 0;
    const total = tasks.length;

    try {
      // Jalankan semua promise, tapi update progress setiap kali satu selesai
      await Promise.all(tasks.map(task => {
        return task.promise.then(() => {
          completed++;
          const percent = Math.floor((completed / total) * 100);
          updateLoadingUI(percent, `Memuat ${task.name}...`);
        });
      }));

      // Selesai
      updateLoadingUI(100, 'Siap!');
      setTimeout(() => {
        UI.overlay.classList.remove('active');
        UI.statusBadge.textContent = "AI Ready";
        UI.statusBadge.classList.add('ready');
        modelsLoaded = true;
        checkReady();
      }, 500);

    } catch (err) {
      console.error(err);
      UI.loadingStatus.textContent = "Gagal memuat model";
      UI.loadingPercent.textContent = "Error";
      UI.loadingPercent.style.color = "#ef4444";
      UI.retryBtn.style.display = 'inline-block';
      alert("Gagal memuat model AI. Pastikan internet lancar dan tidak membuka file HTML langsung (gunakan local server).");
    }
  }

  function updateLoadingUI(percent, text) {
    UI.loadingPercent.textContent = percent + '%';
    UI.progressFill.style.width = percent + '%';
    UI.loadingStatus.textContent = text;
  }

  // --- IMAGE HANDLING ---
  function handleImageUpload(type, event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        // Resize jika terlalu besar untuk performa mobile
        const maxDim = 1024;
        let w = img.width, h = img.height;
        if (w > maxDim || h > maxDim) {
          const ratio = Math.min(maxDim / w, maxDim / h);
          w = w * ratio;
          h = h * ratio;
        }

        INPUTS[type].img = img; // Simpan elemen img asli (bisa di resize on the fly saat proses)
        
        // Tampilkan preview
        INPUTS[type].container.innerHTML = '';
        const previewImg = img.cloneNode();
        previewImg.style.width = '100%';
        previewImg.style.height = '100%';
        previewImg.style.objectFit = 'contain';
        INPUTS[type].container.appendChild(previewImg);

        checkReady();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  INPUTS.target.input.addEventListener('change', (e) => handleImageUpload('target', e));
  INPUTS.donor.input.addEventListener('change', (e) => handleImageUpload('donor', e));

  function checkReady() {
    if (modelsLoaded && INPUTS.target.img && INPUTS.donor.img) {
      UI.swapBtn.disabled = false;
      UI.swapBtn.textContent = "Tukar Wajah Sekarang";
    } else {
      UI.swapBtn.disabled = true;
    }
  }

  // --- CORE SWAP LOGIC ---
  UI.swapBtn.onclick = async () => {
    if (!modelsLoaded) return;
    
    // Tampilkan loading lagi
    UI.overlay.classList.add('active');
    updateLoadingUI(0, 'Menganalisis Wajah...');
    
    // Delay sedikit agar UI render
    setTimeout(async () => {
      try {
        await processFaceSwap();
      } catch (error) {
        alert("Terjadi kesalahan: " + error.message);
        console.error(error);
      } finally {
        UI.overlay.classList.remove('active');
      }
    }, 100);
  };

  async function processFaceSwap() {
    const targetImg = INPUTS.target.img;
    const donorImg = INPUTS.donor.img;

    // Opsi deteksi (TinyFace untuk performa HP)
    const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: 0.5 });

    // 1. Deteksi Target
    updateLoadingUI(20, 'Scan Target...');
    const targetDetection = await faceapi.detectSingleFace(targetImg, options).withFaceLandmarks();
    
    if (!targetDetection) throw new Error("Wajah tidak ditemukan di foto Target.");

    // 2. Deteksi Donor
    updateLoadingUI(50, 'Scan Donor...');
    const donorDetection = await faceapi.detectSingleFace(donorImg, options).withFaceLandmarks();

    if (!donorDetection) throw new Error("Wajah tidak ditemukan di foto Donor.");

    // 3. Persiapan Canvas
    updateLoadingUI(75, 'Menggabungkan...');
    const canvas = UI.canvas;
    const ctx = canvas.getContext('2d');
    
    // Set ukuran canvas sesuai target
    canvas.width = targetImg.width;
    canvas.height = targetImg.height;

    // Gambar target asli dulu
    ctx.drawImage(targetImg, 0, 0);

    // --- LOGIKA COPY & MASKING SEDERHANA ---
    
    // Ambil landmark
    const tLandmarks = targetDetection.landmarks;
    const dLandmarks = donorDetection.landmarks;
    
    // Hitung Bounding Box wajah di target (untuk penempatan)
    const tBox = targetDetection.detection.box;
    // Hitung Bounding Box wajah di donor (untuk crop)
    const dBox = donorDetection.detection.box;

    // Buat Canvas temporary untuk donor yang sudah di-crop
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    // Beri margin sedikit agar tidak terlalu ngepas
    const margin = 0.1; 
    const sWidth = dBox.width * (1 + margin*2);
    const sHeight = dBox.height * (1 + margin*2);
    const sX = dBox.x - (dBox.width * margin);
    const sY = dBox.y - (dBox.height * margin);

    tempCanvas.width = sWidth;
    tempCanvas.height = sHeight;

    // 1. Gambar wajah donor ke temp canvas
    tempCtx.drawImage(donorImg, sX, sY, sWidth, sHeight, 0, 0, sWidth, sHeight);

    // 2. Buat Masking (Bentuk Oval Halus) di temp canvas agar tidak kotak
    tempCtx.globalCompositeOperation = 'destination-in';
    tempCtx.beginPath();
    // Gunakan ellipse sederhana yang pas di tengah temp canvas
    tempCtx.ellipse(sWidth/2, sHeight/2, sWidth*0.4, sHeight*0.45, 0, 0, Math.PI * 2);
    tempCtx.fillStyle = 'black';
    tempCtx.fill();
    // Reset composite
    tempCtx.globalCompositeOperation = 'source-over';

    // 3. Tempel Temp Canvas ke Target Utama
    // Kita perlu scale tempCanvas agar pas dengan ukuran wajah target
    const tWidth = tBox.width * (1 + margin*2);
    const tHeight = tBox.height * (1 + margin*2);
    const tX = tBox.x - (tBox.width * margin);
    const tY = tBox.y - (tBox.height * margin);

    // Optional: Global Alpha untuk blending sedikit jika warna kulit beda jauh
    // ctx.globalAlpha = 0.9; 
    
    ctx.drawImage(tempCanvas, 0, 0, sWidth, sHeight, tX, tY, tWidth, tHeight);
    // ctx.globalAlpha = 1.0;

    // Selesai
    updateLoadingUI(100, 'Selesai!');
    UI.resultArea.classList.add('show');
    UI.resultArea.scrollIntoView({ behavior: 'smooth' });
    
    // Siapkan link download
    UI.downloadLink.href = canvas.toDataURL("image/jpeg");
    UI.downloadLink.download = "hasil-swap.jpg";
  }

  // Reset
  UI.resetBtn.onclick = () => {
    INPUTS.target.img = null;
    INPUTS.donor.img = null;
    INPUTS.target.input.value = '';
    INPUTS.donor.input.value = '';
    INPUTS.target.container.innerHTML = '<span class="preview-placeholder">Pilih Foto</span>';
    INPUTS.donor.container.innerHTML = '<span class="preview-placeholder">Pilih Foto</span>';
    UI.resultArea.classList.remove('show');
    const ctx = UI.canvas.getContext('2d');
    ctx.clearRect(0,0,UI.canvas.width, UI.canvas.height);
    checkReady();
  };

  UI.retryBtn.onclick = loadModels;

  // Mulai Load saat halaman dibuka
  window.addEventListener('DOMContentLoaded', loadModels);

</script>
</body>
</html>

